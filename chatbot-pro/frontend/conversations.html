<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot Pro - ×©×™×—×•×ª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#00D4AA','primary-dark':'#00A080',secondary:'#0066FF',dark:'#1A1A2E',success:'#00E676'}}}}</script>
    <style>
        *{font-family:'Heebo',sans-serif}.glass{background:rgba(255,255,255,.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.3)}.gradient-bg{background:linear-gradient(135deg,#f5f7fa 0%,#e4e8ec 100%)}.gradient-primary{background:linear-gradient(135deg,#00D4AA 0%,#00A080 100%)}.gradient-secondary{background:linear-gradient(135deg,#0066FF 0%,#0052CC 100%)}.card-hover{transition:all .3s cubic-bezier(.4,0,.2,1)}.card-hover:hover{transform:translateY(-2px);box-shadow:0 8px 30px 0 rgba(31,38,135,.1)}.skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite}@keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}.sidebar-item{transition:all .2s ease}.sidebar-item:hover{background:rgba(0,212,170,.1)}.sidebar-item.active{background:rgba(0,212,170,.15);border-right:3px solid #00D4AA}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.toast{animation:slideIn .3s ease}.pulse-dot{animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.badge-success{background:rgba(0,230,118,.15);color:#00C853}.badge-warning{background:rgba(255,193,7,.15);color:#FF9800}.badge-info{background:rgba(0,102,255,.15);color:#0066FF}.badge-error{background:rgba(244,67,54,.15);color:#F44336}.badge-gray{background:rgba(158,158,158,.15);color:#757575}
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="toast-container" class="fixed top-4 left-4 z-50 flex flex-col gap-2"></div>
    <div class="flex min-h-screen">
        <aside class="sidebar w-64 bg-white shadow-lg fixed h-full z-40">
            <div class="p-6 border-b border-gray-100"><div class="flex items-center gap-3"><div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center"><i data-lucide="message-square" class="w-5 h-5 text-white"></i></div><div><h1 class="text-lg font-bold text-dark">ChatBot Pro</h1><p class="text-xs text-gray-500">× ×™×”×•×œ ×‘×•×˜ ×•×•××˜×¡××¤</p></div></div></div>
            <nav class="p-4"><ul class="space-y-1">
                <li><a href="index.html" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:text-dark"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>×“×©×‘×•×¨×“</span></a></li>
                <li><a href="conversations.html" class="sidebar-item active flex items-center gap-3 px-4 py-3 rounded-lg text-dark"><i data-lucide="message-circle" class="w-5 h-5"></i><span>×©×™×—×•×ª</span><span class="mr-auto bg-primary text-white text-xs px-2 py-0.5 rounded-full" id="unread-count">0</span></a></li>
                <li><a href="knowledge.html" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:text-dark"><i data-lucide="book-open" class="w-5 h-5"></i><span>×××’×¨ ××™×“×¢</span></a></li>
                <li><a href="settings.html" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:text-dark"><i data-lucide="settings" class="w-5 h-5"></i><span>×”×’×“×¨×•×ª</span></a></li>
            </ul></nav>
            <div class="absolute bottom-0 w-full p-4 border-t border-gray-100"><div class="glass rounded-xl p-3"><div class="flex items-center gap-3"><div class="w-3 h-3 bg-success rounded-full pulse-dot"></div><div><p class="text-sm font-medium text-dark">××¦×‘ ×“××•</p><p class="text-xs text-gray-500">× ×ª×•× ×™× ×œ×“×•×’××”</p></div></div></div></div>
        </aside>
        <main class="flex-1 mr-64 p-8">
            <header class="flex items-center justify-between mb-8 opacity-0" id="header">
                <div><h2 class="text-2xl font-bold text-dark">×©×™×—×•×ª ğŸ’¬</h2><p class="text-gray-500">×”×™×¡×˜×•×¨×™×™×ª ×›×œ ×”×©×™×—×•×ª ×¢× ×œ×§×•×—×•×ª</p></div>
                <div class="flex items-center gap-3">
                    <button onclick="markAllAsRead()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors flex items-center gap-2"><i data-lucide="check-check" class="w-4 h-4"></i>×¡××Ÿ ×”×›×œ ×›× ×§×¨×</button>
                    <button onclick="exportConversations()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>×™×™×¦×•×</button>
                </div>
            </header>
            <section class="glass rounded-2xl p-4 mb-6 opacity-0" id="filters-section">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex-1 min-w-64 relative"><i data-lucide="search" class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i><input type="text" id="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ×”×•×“×¢×”..." class="w-full pr-10 pl-4 py-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-primary focus:bg-white transition-all"></div>
                    <select id="status-filter" class="px-4 py-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-primary"><option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option><option value="answered">âœ“ × ×¢× ×”</option><option value="no_answer">â³ ×××ª×™×Ÿ ×œ××¢× ×”</option><option value="scheduling">ğŸ“… ×§×‘×™×¢×ª ×¤×’×™×©×”</option></select>
                    <select id="read-filter" class="px-4 py-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-primary"><option value="">×”×›×œ</option><option value="unread">ğŸ“© ×œ× × ×§×¨××•</option><option value="read">âœ“ × ×§×¨××•</option></select>
                </div>
            </section>
            <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 opacity-0" id="stats-bar">
                <div class="glass rounded-xl p-4 flex items-center gap-3"><div class="w-10 h-10 bg-primary/20 rounded-lg flex items-center justify-center"><i data-lucide="message-square" class="w-5 h-5 text-primary"></i></div><div><p class="text-xl font-bold text-dark" id="total-conversations">0</p><p class="text-xs text-gray-500">×¡×”"×› ×©×™×—×•×ª</p></div></div>
                <div class="glass rounded-xl p-4 flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"><i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i></div><div><p class="text-xl font-bold text-dark" id="answered-count">0</p><p class="text-xs text-gray-500">× ×¢× ×•</p></div></div>
                <div class="glass rounded-xl p-4 flex items-center gap-3"><div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center"><i data-lucide="clock" class="w-5 h-5 text-orange-600"></i></div><div><p class="text-xl font-bold text-dark" id="pending-count">0</p><p class="text-xs text-gray-500">×××ª×™× ×™×</p></div></div>
                <div class="glass rounded-xl p-4 flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><i data-lucide="trending-up" class="w-5 h-5 text-blue-600"></i></div><div><p class="text-xl font-bold text-dark" id="answer-rate">0%</p><p class="text-xs text-gray-500">××—×•×– ××¢× ×”</p></div></div>
            </section>
            <section class="glass rounded-2xl p-6 opacity-0" id="conversations-section">
                <div class="space-y-3" id="conversations-list">
                    <div class="conversation-skeleton flex items-center gap-4 p-4 border border-gray-100 rounded-xl"><div class="skeleton w-12 h-12 rounded-full"></div><div class="flex-1"><div class="skeleton h-4 w-32 mb-2 rounded"></div><div class="skeleton h-3 w-full rounded"></div></div><div class="skeleton h-6 w-20 rounded-full"></div></div>
                    <div class="conversation-skeleton flex items-center gap-4 p-4 border border-gray-100 rounded-xl"><div class="skeleton w-12 h-12 rounded-full"></div><div class="flex-1"><div class="skeleton h-4 w-32 mb-2 rounded"></div><div class="skeleton h-3 w-full rounded"></div></div><div class="skeleton h-6 w-20 rounded-full"></div></div>
                    <div class="conversation-skeleton flex items-center gap-4 p-4 border border-gray-100 rounded-xl"><div class="skeleton w-12 h-12 rounded-full"></div><div class="flex-1"><div class="skeleton h-4 w-32 mb-2 rounded"></div><div class="skeleton h-3 w-full rounded"></div></div><div class="skeleton h-6 w-20 rounded-full"></div></div>
                </div>
                <div class="hidden text-center py-16" id="empty-state"><div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center"><i data-lucide="message-square-off" class="w-12 h-12 text-gray-400"></i></div><h3 class="text-xl font-bold text-dark mb-2">××™×Ÿ ×©×™×—×•×ª</h3><p class="text-gray-500">×‘×¨×’×¢ ×©×œ×§×•×—×•×ª ×™×©×œ×—×• ×”×•×“×¢×•×ª, ×”×Ÿ ×™×•×¤×™×¢×• ×›××Ÿ</p></div>
            </section>
        </main>
    </div>
    <div id="detail-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeDetailModal()"></div>
        <div class="absolute top-0 left-0 h-full w-full max-w-xl bg-white shadow-2xl overflow-y-auto" style="animation: slideFromLeft 0.3s ease">
            <div class="sticky top-0 bg-white border-b border-gray-100 p-4 flex items-center justify-between z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-secondary rounded-full flex items-center justify-center"><span class="text-white font-bold" id="detail-initials">--</span></div>
                    <div><h3 class="font-bold text-dark" id="detail-name">×˜×•×¢×Ÿ...</h3><p class="text-sm text-gray-500" id="detail-phone"></p></div>
                </div>
                <button onclick="closeDetailModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
            </div>
            <div class="p-4 space-y-4" id="detail-content">
                <div class="bg-gray-50 rounded-xl p-4"><p class="text-sm text-gray-500 mb-1">×”×•×“×¢×ª ×”×œ×§×•×—:</p><p class="text-dark" id="detail-message"></p><p class="text-xs text-gray-400 mt-2" id="detail-time"></p></div>
                <div class="bg-primary/10 rounded-xl p-4"><p class="text-sm text-gray-500 mb-1">×ª×©×•×‘×ª ×”×‘×•×˜:</p><p class="text-dark whitespace-pre-line" id="detail-response"></p><div class="flex items-center gap-2 mt-2"><span class="text-xs px-2 py-1 rounded-full" id="detail-status"></span><span class="text-xs text-gray-400" id="detail-confidence"></span></div></div>
                <div class="border-t border-gray-100 pt-4"><p class="text-sm font-medium text-dark mb-3">×¤×¢×•×œ×•×ª:</p><div class="flex flex-wrap gap-2">
                    <button onclick="addToKnowledge()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary-dark transition-colors flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i>×”×•×¡×£ ×œ×××’×¨</button>
                    <button onclick="markAsHandled()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition-colors flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i>×¡××Ÿ ×›×˜×•×¤×œ</button>
                </div></div>
            </div>
        </div>
    </div>
    <style>@keyframes slideFromLeft{from{transform:translateX(-100%)}to{transform:translateX(0)}}</style>
<script>
const BUSINESS_ID = getBusinessId();
let conversations = [];
let selectedConversation = null;

lucide.createIcons();
gsap.set('#header', { opacity: 0, y: -20 });
gsap.set('#filters-section', { opacity: 0, y: 20 });
gsap.set('#stats-bar', { opacity: 0, y: 20 });
gsap.set('#conversations-section', { opacity: 0, y: 20 });

function initAnimations() {
    gsap.to('#header', { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' });
    gsap.to('#filters-section', { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out', delay: 0.2 });
    gsap.to('#stats-bar', { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out', delay: 0.3 });
    gsap.to('#conversations-section', { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out', delay: 0.4 });
}

async function loadConversations() {
    try {
        if (isDemoMode()) { conversations = [...DEMO_DATA.conversations]; }
        else {
            const db = getSupabase();
            const { data, error } = await db.from('conversations').select('*').eq('business_id', BUSINESS_ID).order('timestamp', { ascending: false });
            if (error) throw error;
            conversations = data || [];
        }
        renderConversations();
        updateStats();
    } catch (error) {
        console.error('Error:', error);
        conversations = [...DEMO_DATA.conversations];
        renderConversations();
        updateStats();
    }
}

function renderConversations(items = conversations) {
    const list = document.getElementById('conversations-list');
    const emptyState = document.getElementById('empty-state');
    list.querySelectorAll('.conversation-skeleton, .conversation-item').forEach(el => el.remove());
    if (items.length === 0) { emptyState.classList.remove('hidden'); return; }
    emptyState.classList.add('hidden');
    items.forEach((conv, index) => {
        const displayName = conv.customer_name || formatPhone(conv.customer_phone);
        const badge = RESPONSE_TYPE_LABELS[conv.response_type] || RESPONSE_TYPE_LABELS.answered;
        const card = document.createElement('div');
        card.className = `conversation-item card-hover flex items-center gap-4 p-4 border rounded-xl cursor-pointer ${!conv.is_read ? 'border-primary/30 bg-primary/5' : 'border-gray-100'}`;
        card.style.opacity = '0';
        card.innerHTML = `
            <div class="w-12 h-12 gradient-secondary rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white font-bold">${getInitials(displayName)}</span></div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <h4 class="font-medium text-dark">${displayName}</h4>
                    <span class="text-xs text-gray-400">${getTimeAgo(conv.timestamp)}</span>
                    ${!conv.is_read ? '<span class="w-2 h-2 bg-primary rounded-full"></span>' : ''}
                </div>
                <p class="text-sm text-gray-600 truncate">${conv.message}</p>
            </div>
            <span class="${badge.class} text-xs px-3 py-1 rounded-full flex-shrink-0">${badge.text}</span>
        `;
        card.onclick = () => openDetailModal(conv);
        list.appendChild(card);
        gsap.to(card, { opacity: 1, y: 0, duration: 0.3, delay: index * 0.05, ease: 'power2.out' });
    });
    lucide.createIcons();
}

function updateStats() {
    const total = conversations.length;
    const answered = conversations.filter(c => c.response_type === 'answered').length;
    const pending = conversations.filter(c => c.response_type === 'no_answer' || c.needs_followup).length;
    const unread = conversations.filter(c => !c.is_read).length;
    const rate = total > 0 ? Math.round((answered / total) * 100) : 0;
    document.getElementById('total-conversations').textContent = total;
    document.getElementById('answered-count').textContent = answered;
    document.getElementById('pending-count').textContent = pending;
    document.getElementById('answer-rate').textContent = rate + '%';
    document.getElementById('unread-count').textContent = unread;
}

function openDetailModal(conv) {
    selectedConversation = conv;
    const displayName = conv.customer_name || formatPhone(conv.customer_phone);
    const badge = RESPONSE_TYPE_LABELS[conv.response_type] || RESPONSE_TYPE_LABELS.answered;
    document.getElementById('detail-initials').textContent = getInitials(displayName);
    document.getElementById('detail-name').textContent = displayName;
    document.getElementById('detail-phone').textContent = formatPhone(conv.customer_phone);
    document.getElementById('detail-message').textContent = conv.message;
    document.getElementById('detail-time').textContent = formatDate(conv.timestamp) + ' ' + formatTime(conv.timestamp);
    document.getElementById('detail-response').textContent = conv.bot_response || '×œ× × ×©×œ×—×” ×ª×©×•×‘×”';
    document.getElementById('detail-status').textContent = badge.text;
    document.getElementById('detail-status').className = `text-xs px-2 py-1 rounded-full ${badge.class}`;
    document.getElementById('detail-confidence').textContent = conv.ai_confidence ? `×‘×™×˜×—×•×Ÿ: ${Math.round(conv.ai_confidence * 100)}%` : '';
    document.getElementById('detail-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    if (!conv.is_read) { conv.is_read = true; renderConversations(); updateStats(); }
    lucide.createIcons();
}

function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
    document.body.style.overflow = '';
    selectedConversation = null;
}

function addToKnowledge() {
    if (!selectedConversation) return;
    const question = selectedConversation.message;
    closeDetailModal();
    window.location.href = `knowledge.html?add=true&question=${encodeURIComponent(question)}`;
}

function markAsHandled() {
    if (!selectedConversation) return;
    selectedConversation.needs_followup = false;
    showToast('×”×©×™×—×” ×¡×•×× ×” ×›×˜×•×¤×œ×”');
    closeDetailModal();
    renderConversations();
    updateStats();
}

function markAllAsRead() {
    conversations.forEach(c => c.is_read = true);
    renderConversations();
    updateStats();
    showToast('×›×œ ×”×©×™×—×•×ª ×¡×•×× ×• ×›× ×§×¨××•');
}

function exportConversations() {
    const csv = ['×©×,×˜×œ×¤×•×Ÿ,×”×•×“×¢×”,×ª×©×•×‘×”,×¡×˜×˜×•×¡,×ª××¨×™×š'];
    conversations.forEach(c => {
        csv.push(`"${c.customer_name || ''}","${c.customer_phone}","${c.message}","${c.bot_response || ''}","${c.response_type}","${c.timestamp}"`);
    });
    const blob = new Blob(['\ufeff' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'conversations.csv';
    link.click();
    showToast('×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”');
}

document.getElementById('search-input').addEventListener('input', filterConversations);
document.getElementById('status-filter').addEventListener('change', filterConversations);
document.getElementById('read-filter').addEventListener('change', filterConversations);

function filterConversations() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const status = document.getElementById('status-filter').value;
    const readFilter = document.getElementById('read-filter').value;
    let filtered = conversations;
    if (search) filtered = filtered.filter(c => (c.customer_name || '').toLowerCase().includes(search) || c.customer_phone.includes(search) || c.message.toLowerCase().includes(search));
    if (status) filtered = filtered.filter(c => c.response_type === status);
    if (readFilter === 'unread') filtered = filtered.filter(c => !c.is_read);
    else if (readFilter === 'read') filtered = filtered.filter(c => c.is_read);
    renderConversations(filtered);
}

// Check URL for filter param
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('filter') === 'no_answer') {
    document.getElementById('status-filter').value = 'no_answer';
}

document.addEventListener('DOMContentLoaded', () => { initAnimations(); loadConversations(); });
</script>
</body>
</html>
